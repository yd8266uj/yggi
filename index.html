<!DOCTYPE html>
<html>
<body>
<div id="version">-a9</div>
<div id="log"></div>
<video></video>
<script>
		var constraints = {"audio": false, "video": { "mandatory": { "minWidth": 320, "maxWidth": 320, "minHeight": 240,"maxHeight": 240 }, "optional": [] } };
//		var constraints = {audio: true,video: { width: { min: 320, ideal: 320, max: 1280 }, height: { min: 240, ideal: 240, max: 720 }}}; 
 
	navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
	var videoElement = document.querySelector('video');
	videoElement.controls = false;
	if (typeof MediaRecorder === 'undefined' || !navigator.getUserMedia) {
      alert('Sorry! This demo requires Firefox 30 and up or Chrome 47 and up.');
    }


	function speak(text, callback) {
		var u = new SpeechSynthesisUtterance();
		u.text = text;
		u.lang = 'en-US';
		u.voice = 'Google US English';
	 
		u.onend = function () {
			if (callback) {
				callback();
			}
		};
	 
		u.onerror = function (e) {
			if (callback) {
				callback(e);
			}
		};
	 
		speechSynthesis.speak(u);
	}
	function errorCallback() {}
	function startRecording(stream) {
		log('Starting camera...');
		mediaRecorder = new MediaRecorder(stream);

		mediaRecorder.start();

		var url = window.URL || window.webkitURL;
		videoElement.src = url ? url.createObjectURL(stream) : stream;
		videoElement.play();

		mediaRecorder.ondataavailable = function(e) {
			//log('Data available...');
			chunks.push(e.data);
		};

		mediaRecorder.onerror = function(e){
			log('Error: ' + e);
			console.log('Error: ', e);
		};


		mediaRecorder.onstart = function(){
			log('Started, state = ' + mediaRecorder.state);
		};

		mediaRecorder.onstop = function(){
			log('Stopped, state = ' + mediaRecorder.state);

			var blob = new Blob(chunks, {type: "video/webm"});
			chunks = [];

			var videoURL = window.URL.createObjectURL(blob);

			downloadLink.href = videoURL;
			videoElement.src = videoURL;
			downloadLink.innerHTML = 'Download video file';

			var rand = Math.floor((Math.random() * 10000000));
			var name = "video_"+rand+".webm" ;

			downloadLink.setAttribute( "download", name);
			downloadLink.setAttribute( "name", name);

		};

		mediaRecorder.onwarning = function(e){
			log('Warning: ' + e);
		};
	}
 
 

    speak('Let me know when you are ready to begin', function () {
	
		var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition
		var SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList
		var SpeechRecognitionEvent = SpeechRecognitionEvent || webkitSpeechRecognitionEvent
		var grammar = '#JSGF V1.0; grammar commands; public <command> = begin | end ;';

		var recognition = new SpeechRecognition();
		var speechRecognitionList = new SpeechGrammarList();
		speechRecognitionList.addFromString(grammar, 1);
		recognition.grammars = speechRecognitionList;
		recognition.continuous = true;
		recognition.lang = 'en-US';
		recognition.interimResults = false;
		recognition.maxAlternatives = 1;
 
		recognition.onresult = function (event) {
			console.log(event);
			var command = event.results[event.resultIndex][0].transcript.trim();
			log(command);
			if( 'begin' == command ) {
				navigator.getUserMedia(constraints, startRecording, errorCallback);
			}
			if( 'end' == command ) {
				mediaRecorder.stop();
			}
		}
		
		recognition.onspeechend = function() {
			//log('stopped');
			//recognition.stop();
		}

		recognition.onnomatch = function(event) {
			log('no match');
		}

		recognition.onerror = function(event) {
			log('error: ' + event.error);
		}
	 
		// start listening
		recognition.start();
		log('listening...');
    });

	
	function log(string) {
		var log = document.getElementById('log');
		log.innerHTML = string + '<br>' + log.innerHTML;
	}
</script>
</body>
</html>